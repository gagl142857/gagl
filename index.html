<!DOCTYPE html>
<html lang="ko">

<head>
    <script>
        fetch('/version.txt')
            .then(res => res.text())
            .then(version => {
                const saved = localStorage.getItem('version');
                if (saved !== version.trim()) {
                    localStorage.setItem('version', version.trim());
                    location.reload(true);
                }
            });
    </script>

    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-database-compat.js"></script>


    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">

    <meta charset="UTF-8">
    <title>gagl</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: black;
            margin: 0;
            padding: 0;
            color: white;
            display: flex;
            /* justify-content: center; */
            align-items: center;
            flex-direction: column;
            height: 100vh;
            font-size: 14px;
            /* position: fixed; */
            /* 화면고정배치 스크롤해도 안움직임 */
            /* justify-content: space-between; */
            /* 양쪽정렬 */
            font-weight: 500;
        }

        .밑줄 {
            border-bottom: 0.2px solid #2e2e2e;
            /* position: fixed; */
            /* top: 0; */
            width: 100%;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .가로정렬 {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .세로정렬 {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 10px;
        }

        .양쪽정렬 {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 10px;
        }

        .사백픽셀 {
            width: 400px;
        }

        .버튼 {
            border-radius: 5px;
            padding: 5px;
        }

        .버튼:hover {
            background-color: #333;
            cursor: pointer;
        }

        .커서호버:hover {
            cursor: pointer;
        }

        .사백픽셀테두리 {
            margin-top: 15px;
            width: 400px;
            border: 0.2px solid #2e2e2e;
            border-radius: 10px;
            padding: 15px;
        }

        .기본테두리 {
            margin-top: 15px;
            width: 100%;
            box-sizing: border-box;
            border: 0.2px solid #2e2e2e;
            border-radius: 10px;
            padding: 15px;
        }

        .유저몬스터테두리 {
            width: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 10px;
        }

        .에너지바 {
            background-color: #eab308;
            height: 5px;
            border-radius: 10px;
            width: 100%;
        }

        .유저테두리 {
            border: 0.2px solid #2614c7;
            border-radius: 10px;
            padding: 15px;
            /* width: 100%; */
        }

        .몬스터테두리 {
            border: 0.2px solid #c71414;
            border-radius: 10px;
            padding: 15px;
            /* width: 100%; */

        }

        .경험치골드숙련도 {
            background-color: #121212;
            height: 85px;
            border-radius: 10px;
            width: 100px;
            padding: 15px;
        }

        .레벨 {
            color: #00c851;
        }

        .총경험치 {
            color: #ffffff;
            font-size: 16px;
            font-weight: bold;
        }

        .획득경험치 {
            color: #7a7a7a;
            font-size: 10px;
            font-weight: lighter;
        }

        .골드 {
            color: #b0b0b0;
        }

        .총골드 {
            color: #f5c400;
            font-size: 16px;
            font-weight: bold;
        }

        .획득골드 {
            color: #00c851;
            font-size: 10px;
            font-weight: lighter;
        }

        .숙련도 {
            color: #b0b0b0;
        }

        .총숙련도 {
            color: #3b82f6;
            font-size: 16px;
            font-weight: bold;
        }

        .획득숙련도 {
            color: #00c851;
            font-size: 10px;
            font-weight: lighter;
        }

        .콘솔로그창 {
            color: #ffffff;
            border-radius: 10px;
            position: fixed;
            left: 0;
            bottom: 0;
            font-weight: bold;
        }

        .로딩컨테이너 {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: sans-serif;
            font-size: 16px;
        }

        .로딩스피너 {
            width: 50px;
            height: 50px;
            border: 6px solid #ccc;
            border-top-color: #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* 
        #사냥로그박스 {
            max-height: 220px;
            overflow-y: hidden;
        } */

        #죽음메시지 {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 400px;
            position: fixed;
            top: 33%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: #b0b0b0;
            padding: 15px;
            border: 3px solid #2e2e2e;
            border-radius: 12px;
            /* font-size: 20px; */
            /* font-weight: bold; */
            z-index: 9999;
            box-shadow: 0 0 20px #2e2e2e;
            animation: fadeOut 2s ease-in-out forwards;
            user-select: none;
            pointer-events: none;
        }

        /* 자동으로 사라지게 하는 페이드 아웃 */
        @keyframes fadeOut {
            0% {
                opacity: 1;
            }

            70% {
                opacity: 1;
            }

            100% {
                opacity: 0;
                display: none;
            }
        }



        #승리패배로그 {
            font-size: 16px;
            margin-top: 10px;
        }

        #획득로그 {
            color: #00c851;
        }

        #레벨업표시 {
            color: #00c851;
        }

        #층조절 {
            background: linear-gradient(135deg, #330000, #660000, #990000);
            border: 2px solid #ff3300;
            box-shadow: 0 0 12px #ff0000, 0 0 24px #440000 inset;
            animation: 마계불길 4s ease-in-out infinite;
            gap: 30px;
        }

        @keyframes 마계불길 {

            0%,
            100% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(1.3);
            }
        }

        .crown-icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }

        .금 {
            stroke: gold;
        }

        .은 {
            stroke: silver;
        }

        .동 {
            stroke: #cd7f32;
        }

        #보유숙련도:hover {
            cursor: pointer;
            text-decoration: underline;
            color: #3b82f6;
        }

        .target-icon {
            width: 16px;
            height: 16px;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            margin-right: 4px;
        }

        /* 크리티컬 - 빨강 */
        .알파,
        .베타,
        .감마,
        .델타,
        .엡실론,
        .제타,
        .에타,
        .쎄타,
        .이오타,
        .카파,
        .람다,
        .뮤,
        .뉴,
        .크시,
        .오미크론,
        .파이,
        .로,
        .시그마,
        .타우,
        .입실론,
        .파이2,
        .카이,
        .프시,
        .오메가 {
            stroke: #ef4444;
        }

        /* 드레인 - 주황 */
        .킬로,
        .메가,
        .기가,
        .테라,
        .페타,
        .엑사,
        .제타,
        .요타,
        .로나,
        .쿼카 {
            stroke: #f97316;
        }

        /* 버서커 - 노랑 */
        .앵거,
        .레이지,
        .프렌지,
        .매드니스,
        .하울,
        .새비지,
        .블러드,
        .카오스,
        .데스,
        .루나틱 {
            stroke: #facc15;
        }

        .내아이디강조 {
            background-color: #141414;
            /* font-weight: bold;
            border-radius: 6px; */
        }

        .색상실험 {
            background-color: #8b5cf6;
            background-color: #3bf0f6;
            background-color: #5cf669;
            background-color: #f6ec5c;
        }

        #전투버튼박스 {
            position: relative;
            /* ✅ 추가 */
        }


        /* css추가 */
    </style>
</head>

<body>

    <!-- <div id="로딩화면" class="로딩컨테이너">
        <div class="로딩스피너"></div>
        <div style="margin-top: 10px;">로딩 중입니다...</div>
    </div> -->
    <!-- body 최상단 어디든 가능 -->
    <div id="고정이펙트영역" style="
  position: fixed;
  pointer-events: none;
  z-index: 9999;
  display: none;
"></div>



    <div class="밑줄" id="상단바">
        <div class="양쪽정렬 사백픽셀">
            <div class="커서호버" id="타이틀을아이디로">
                gagl
            </div>
            <div id="전투스킬설정버튼" style="display: none;">
                <div class="가로정렬">
                    <div class="버튼" id="전투">
                        전투
                    </div>
                    <div class="버튼">
                        장비
                    </div>
                    <div class="버튼" id="스킬">
                        스킬
                    </div>
                    <div class="버튼" id="전당">
                        전당
                    </div>
                    <div class="버튼" id="탈퇴">
                        탈퇴
                    </div>
                </div>
            </div>
        </div>
    </div>




    <div class="사백픽셀테두리 세로정렬" id="에너지박스" style="display: none;">
        <div class="양쪽정렬">
            <div style="color: #eab308;">
                <!-- 루시드 zap 아이콘 SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="lucide lucide-zap-icon lucide-zap">
                    <path
                        d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z" />
                </svg>
            </div>
            <div>
                ♾️
            </div>
        </div>
        <div class="에너지바">

        </div>
    </div>



    <div id="로그인화면" style="display: none;">

        <div class="사백픽셀테두리 세로정렬">
            <input type="text" placeholder="아이디을 입력하세요" id="아이디입력" autocomplete="off" maxlength="8">
            <button onclick="아이디설정()">확인</button>
        </div>
    </div>




    <div id="전투화면" style="display: none;">
        <div class="사백픽셀테두리 가로정렬" id="층조절">
            <div id="아래층으로">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="lucide lucide-arrow-big-down-dash-icon lucide-arrow-big-down-dash">
                    <path d="M15 5H9" />
                    <path d="M15 9v3h4l-7 7-7-7h4V9z" />
                </svg>
            </div>
            <div id="현재층">
                1층

            </div>
            <div id="위층으로">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="lucide lucide-arrow-big-up-dash-icon lucide-arrow-big-up-dash">
                    <path d="M9 19h6" />
                    <path d="M9 15v-3H5l7-7 7 7h-4v3H9z" />
                </svg>
            </div>

        </div>

        <div id="사냥결과">
            <div class="사백픽셀테두리 세로정렬">
                <div class="가로정렬">
                    <div class="경험치골드숙련도 세로정렬">
                        <div class="레벨" id="레벨">
                            레벨 129
                        </div>
                        <div class="총경험치" id="총경험치">
                            12,932
                        </div>
                        <div class="획득경험치" id="획득경험치">
                            45
                        </div>
                    </div>
                    <div class="경험치골드숙련도 세로정렬">
                        <div class="골드" id="골드">
                            골드
                        </div>
                        <div class="총골드" id="총골드">
                            999,999
                        </div>
                        <div class="획득골드" id="획득골드">
                            999
                        </div>

                    </div>
                    <div class="경험치골드숙련도 세로정렬">
                        <div class="숙련도" id="숙련도">
                            숙련도
                        </div>
                        <div class="총숙련도" id="총숙련도">
                            999,999
                        </div>
                        <div class="획득숙련도" id="획득숙련도">
                            999
                        </div>

                    </div>
                </div>

                <div class="가로정렬" id="승리패배로그">
                </div>
                <div class="가로정렬" id="획득로그">
                </div>

                <div class="가로정렬" id="레벨업표시">

                </div>
            </div>
        </div>

        <div class="사백픽셀테두리 가로정렬" id="전투버튼박스">
            <div class="버튼" id="공격버튼">⚔️ 공격하기</div>
            <div class="버튼" id="자동사냥버튼">⏱ 자동사냥</div>
        </div>



        <div class="사백픽셀테두리 유저테두리 양쪽정렬">
            <div id="유저아이디">
                영자
            </div>
            <div class="세로정렬">
                <div id="유저공격력">
                    공격력 100
                </div>
                <div id="유저체력">
                    체력 100
                </div>
            </div>

        </div>
        <div class="사백픽셀테두리 몬스터테두리 양쪽정렬">
            <div id="악마이름">
                몬스터
            </div>
            <div class="세로정렬">
                <div id="악마체력">
                    체력 100
                </div>
                <div id="악마방어력">
                    방어력 10
                </div>
            </div>
        </div>


    </div>

    <div id="전당화면" style="display: none;">
        <div id="전당컨테이너" class="사백픽셀테두리 세로정렬">
        </div>
    </div>

    <div class="콘솔로그창" id="콘솔로그창">

    </div>

    <div id="죽음메시지" style="display: none;"></div>

    <div id="블로커" style="
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0);
  z-index: 9999;
  display: none;
  cursor: wait;
"></div>

    <div id="장비화면" style="display: none;">
        <div class="사백픽셀테두리" id="장비컨테이너">
        </div>
    </div>

    <div id="스킬화면" style="display: none;">
        <div class="밑줄" id="보유숙련도">

        </div>

        <div class="사백픽셀테두리" id="스킬컨테이너">
        </div>
    </div>


    <!-- 객체추가 -->


    <script>
        // // 콘솔 로그 출력용
        // const 원래로그 = console.log;
        // console.log = function (...args) {
        //     원래로그(...args); // 기존 콘솔에 출력
        //     const 콘솔로그창 = document.getElementById("콘솔로그창");
        //     콘솔로그창.innerText = args.map(arg =>
        //         typeof arg === "object" ? JSON.stringify(arg) : arg
        //     ).join(" ");
        //     콘솔로그창.style.display = "block";
        // };

        // // 에러 메시지 출력용
        // window.onerror = function (message, source, lineno, colno, error) {
        //     const 콘솔로그창 = document.getElementById("콘솔로그창");
        //     콘솔로그창.innerText = `${message} (${lineno}:${colno})`;
        //     콘솔로그창.style.display = "block";
        //     return true;
        // };




        const firebaseConfig = {
            apiKey: "AIzaSyATQ8ecSPS6StHUEv_-b-bw59qtjXoUzHc",
            authDomain: "gagl-eb32b.firebaseapp.com",
            projectId: "gagl-eb32b",
            storageBucket: "gagl-eb32b.firebasestorage.app",
            messagingSenderId: "689475246615",
            appId: "1:689475246615:web:9b5c0d7650e9580e34da52",
            measurementId: "G-2G82FVDY46",
            databaseURL: "https://gagl-eb32b-default-rtdb.firebaseio.com"  // 이 줄 추가
        };



        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();



        let uid = "";
        let 유저데이터 = {};
        let 현재악마 = null;

        let 현재악마체력 = 0;
        let 현재악마최대체력 = 0;
        let 자동사냥중 = false;
        let 자동사냥타이머 = null;

        let 현재몬스터이름 = "";
        let 현재몬스터등급 = "일반";


        const 레어몬스터 = [
            "CCCXIII. 바포메트",
            "IV. 디아블로",
            "CMXCIX. 메피스토",
            "CXXXI. 릴리트",
        ];
        const 신화몬스터 = [
            "LXXXIX. 레비아탄",
            "DCCLXXVII. 벨제붑",
        ];
        const 고대몬스터 = [
            "DCLXVI. 사탄"
        ];


        const 크리티컬이름들 = [
            "알파", "베타", "감마", "델타", "엡실론", "제타", "에타", "쎄타", "이오타", "카파",
            "람다", "뮤", "뉴", "크시", "오미크론", "파이", "로", "시그마", "타우", "입실론",
            "파이2", "카이", "프시", "오메가"
        ];

        const 크리티컬스킬목록 = 크리티컬이름들.map((이름, 인덱스) => {
            const 배율 = (1.1 + 인덱스 * 0.1).toFixed(1); // ✅ 올바른 변수 이름
            return {
                키: `${이름.toLowerCase()}크리티컬확률`,
                이름: `${이름} 크리티컬`,
                설명: `최종데미지 ${배율}배.`,
                최대레벨: 10,
                숙련도소모: 10 + 인덱스 * 10,
                잠금해제조건: 인덱스 === 0 ? null : {
                    키: `${크리티컬이름들[인덱스 - 1].toLowerCase()}크리티컬확률`,
                    최소레벨: 10
                }
            };
        });

        const 드레인이름들 = [
            "킬로", "메가", "기가", "테라", "페타",
            "엑사", "제타", "요타", "로나", "쿼카"
        ];

        const 드레인스킬목록 = 드레인이름들.map((이름, 인덱스) => {
            return {
                키: `${이름.toLowerCase()}드레인흡혈확률`,
                이름: `${이름} 드레인`,
                설명: `몬스터 처치 시 체력 +${인덱스 + 1} 회복.`,
                최대레벨: 10,
                숙련도소모: 10 + 인덱스 * 10,
                잠금해제조건: 인덱스 === 0 ? null : {
                    키: `${드레인이름들[인덱스 - 1].toLowerCase()}드레인흡혈확률`,
                    최소레벨: 10
                }
            };
        });

        const 버서커이름들 = [
            "앵거", "레이지", "프렌지", "매드니스", "하울",
            "새비지", "블러드", "카오스", "데스", "루나틱"
        ];

        const 버서커배율목록 = [1.3, 1.6, 1.9, 2.2, 2.5, 2.8, 3.1, 3.4, 3.7, 4.0];

        const 버서커스킬목록 = 버서커이름들.map((이름, 인덱스) => {
            const 배율 = 버서커배율목록[인덱스].toFixed(1);
            const 소모 = 인덱스 + 1;
            return {
                키: `${이름.toLowerCase()}버서커데미지증가확률`,
                이름: `${이름} 버서커`,
                설명: `체력소모+${소모},최종데미지${배율}배.`,
                최대레벨: 10,
                숙련도소모: 10 + 인덱스 * 10,
                잠금해제조건: 인덱스 === 0 ? null : {
                    키: `${버서커이름들[인덱스 - 1].toLowerCase()}버서커데미지증가확률`,
                    최소레벨: 10
                }
            };
        });


        const 스킬목록 = [
            ...크리티컬스킬목록,
            ...드레인스킬목록,
            ...버서커스킬목록
        ];



        auth.onAuthStateChanged(function (user) {
            if (user) {
                uid = user.uid;

                // document.getElementById("로딩화면").style.display = "block";
                // UID 기준으로 DB 조회
                화면잠금();
                db.ref("users/" + uid).once("value").then((snapshot) => {
                    if (snapshot.exists()) {
                        const 데이터 = snapshot.val();

                        if (데이터.아이디 && 데이터.아이디.trim() !== "") {
                            유저데이터 = 데이터;

                            // ✅ 최대체력 기본값 설정
                            if (!유저데이터.최대체력) {
                                유저데이터.최대체력 = 100;
                            }

                            // ⬇️ 여기!
                            if (!유저데이터.스킬) {
                                유저데이터.스킬 = {};
                            }

                            for (const 스킬 of 스킬목록) {
                                if (!(스킬.키 in 유저데이터.스킬)) {
                                    유저데이터.스킬[스킬.키] = 0;
                                }
                            }

                            전투화면보여주기(유저데이터);
                            화면해제();
                        } else {
                            // ❌ 아이디 없음 → 로그인화면 진입
                            유저데이터 = 데이터;
                            로그인화면보여주기();
                            화면해제();
                        }
                    } else {
                        // ✅ 완전 신규 유저 → 기본 데이터 생성 및 저장
                        유저데이터 = {
                            아이디: "",
                            생성시각: new Date().toISOString(),
                            레벨: 1,
                            공격력: 100,
                            남은체력: 100,
                            최대체력: 100,
                            경험치: 0,
                            골드: 0,
                            숙련도: 0,
                            현재층: 1,
                            현재악마번호: 1,
                            스킬: {} // 일단 빈 객체로 넣고 바로 아래에서 채움
                        };

                        for (const 스킬 of 스킬목록) {
                            유저데이터.스킬[스킬.키] = 0;
                        }

                        db.ref("users/" + uid).set(유저데이터).then(() => {
                            로그인화면보여주기(); // 아이디 없으므로 로그인화면부터
                            화면해제();
                        });
                    }
                });

            } else {
                // 아직 로그인되지 않았으면 → 익명 로그인 시작
                auth.signInAnonymously();
            }
        });

        function 화면잠금() {
            document.getElementById("블로커").style.display = "block";
        }

        function 화면해제() {
            document.getElementById("블로커").style.display = "none";
        }

        function 로그인화면보여주기() {
            // document.getElementById("로딩화면").style.display = "none";
            document.getElementById("전투스킬설정버튼").style.display = "none";
            document.getElementById("에너지박스").style.display = "none";
            document.getElementById("전투화면").style.display = "none";
            document.getElementById("로그인화면").style.display = "block";
            // document.getElementById("사냥로그박스").innerHTML = "";
            document.getElementById("획득로그").innerText = "";
            document.getElementById("레벨업표시").innerText = "";
        }

        function 전투화면보여주기(유저) {
            document.getElementById("로그인화면").style.display = "none";
            document.getElementById("전당화면").style.display = "none";
            document.getElementById("스킬화면").style.display = "none";
            document.getElementById("전투스킬설정버튼").style.display = "block";
            document.getElementById("에너지박스").style.display = "block";
            document.getElementById("전투화면").style.display = "block";

            document.getElementById("유저아이디").innerText = 유저데이터.아이디 || "gagl";
            document.getElementById("타이틀을아이디로").innerText = 유저데이터.아이디 || "gagl";
            document.getElementById("유저공격력").innerText = "공격력 " + (유저데이터.공격력 || 0);
            document.getElementById("유저체력").innerText = `체력 ${유저데이터.남은체력} / ${유저데이터.최대체력}`;
            document.getElementById("현재층").innerText = 유저데이터.현재층 + "층" || "gagl";

            document.getElementById("레벨").innerText = "레벨 " + (유저데이터.레벨 ?? 1);
            document.getElementById("총경험치").innerText = typeof 유저데이터.경험치 === "number" ? 유저데이터.경험치.toLocaleString() : "0";
            document.getElementById("획득경험치").innerText = "0";
            document.getElementById("총골드").innerText = typeof 유저데이터.골드 === "number" ? 유저데이터.골드.toLocaleString() : "0";
            document.getElementById("획득골드").innerText = "0";
            document.getElementById("총숙련도").innerText = typeof 유저데이터.숙련도 === "number" ? 유저데이터.숙련도.toLocaleString() : "0";
            document.getElementById("획득숙련도").innerText = "0";

            // ✅ 특수 몬스터 출현 확률
            const 몬스터출현확률 = {
                고대: 0.001,
                신화: 0.01,
                레어: 0.1
            };

            const 기본이름 = 악마리스트[(유저데이터.현재악마번호 - 1) % 악마리스트.length];
            const 로마번호 = 숫자를로마숫자로(유저데이터.현재악마번호);

            let 특수몬스터이름 = null;
            let 등급 = "일반";
            const r = Math.random();
            if (r < 몬스터출현확률.고대) {
                특수몬스터이름 = 고대몬스터[Math.floor(Math.random() * 고대몬스터.length)];
                등급 = "고대";
            } else if (r < 몬스터출현확률.고대 + 몬스터출현확률.신화) {
                특수몬스터이름 = 신화몬스터[Math.floor(Math.random() * 신화몬스터.length)];
                등급 = "신화";
            } else if (r < 몬스터출현확률.고대 + 몬스터출현확률.신화 + 몬스터출현확률.레어) {
                특수몬스터이름 = 레어몬스터[Math.floor(Math.random() * 레어몬스터.length)];
                등급 = "레어";
            }

            if (자동사냥중 && 등급 !== "일반") {
                자동사냥중 = false;
                clearInterval(자동사냥타이머);
                자동사냥타이머 = null;

                const 버튼 = document.getElementById("자동사냥버튼");
                버튼.innerText = "⏱ 자동사냥";
                버튼.style.color = "white";

                setTimeout(() => {
                    자동사냥토글();
                }, 5000);
            }

            if (등급 !== "일반") {
                const 색상맵 = {
                    "레어": "#3bf0f6",
                    "신화": "#2664c7",
                    "고대": "#EF4444"
                };

                const 컨테이너 = document.createElement("div");
                컨테이너.innerHTML = `
    <div style="display: flex; align-items: center; gap: 6px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
        viewBox="0 0 24 24" fill="none" stroke="${색상맵[등급]}" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round"
        class="lucide lucide-octagon-alert-icon lucide-octagon-alert">
          <path d="M12 16h.01"/>
          <path d="M12 8v4"/>
          <path d="M15.312 2a2 2 0 0 1 1.414.586l4.688 4.688A2 2 0 0 1 22 8.688v6.624a2 2 0 0 1-.586 1.414l-4.688 4.688a2 2 0 0 1-1.414.586H8.688a2 2 0 0 1-1.414-.586l-4.688-4.688A2 2 0 0 1 2 15.312V8.688a2 2 0 0 1 .586-1.414l4.688-4.688A2 2 0 0 1 8.688 2z"/>
        </svg>
        <span style="color: ${색상맵[등급]}; font-weight: bold; font-size: 14px;">
            ${등급}악마 ${특수몬스터이름} 강림!
        </span>
    </div>
    `;

                컨테이너.style.position = "absolute";
                컨테이너.style.left = `${Math.random() * 80 + 10}%`;
                컨테이너.style.top = `${Math.random() * 50 + 20}%`;
                컨테이너.style.zIndex = "9999";
                컨테이너.style.pointerEvents = "none";
                컨테이너.style.whiteSpace = "nowrap";

                document.getElementById("전투버튼박스").appendChild(컨테이너);
                setTimeout(() => 컨테이너.remove(), 2000);
            }

            const 몬스터이름 = 특수몬스터이름 || `${로마번호}. ${기본이름}`;
            document.getElementById("악마이름").innerText = 몬스터이름;

            const 악마 = 현재악마불러오기(유저데이터.현재층, 유저데이터.현재악마번호, 등급);
            현재악마 = 악마;
            현재악마체력 = 악마.체력;
            현재악마최대체력 = 악마.체력;
            현재몬스터이름 = 몬스터이름;
            현재몬스터등급 = 등급;

            document.getElementById("악마체력").innerText = `체력 ${현재악마체력} / ${현재악마최대체력}`;
            document.getElementById("악마방어력").innerText = `방어력 ${악마.방어력}`;
            document.querySelector(".몬스터테두리").style.borderColor = {
                "일반": "#c71414",
                "레어": "#3bf0f6",
                "신화": "#2664c7",
                "고대": "#EF4444"

            }[등급];


            // background-color: #8b5cf6; 
            // background-color: #3bf0f6; 
            // background-color: #5cf669; 
            // background-color: #f6ec5c; 

            document.getElementById("획득로그").innerText = "";
            setTimeout(고정이펙트영역초기화, 0);
        }

        function 전당화면보여주기() {
            document.getElementById("전투화면").style.display = "none";
            document.getElementById("에너지박스").style.display = "none";
            document.getElementById("전당화면").style.display = "block";
            document.getElementById("스킬화면").style.display = "none";
            // document.getElementById("사냥로그박스").innerHTML = "";
            document.getElementById("획득로그").innerText = "";
            document.getElementById("레벨업표시").innerText = "";

            // 🔁 랭킹 초기화
            const 컨테이너 = document.getElementById("전당컨테이너");
            컨테이너.innerHTML = "";

            // 🔍 Firebase에서 모든 유저 조회
            db.ref("users").once("value").then((snapshot) => {
                const 유저리스트 = [];


                snapshot.forEach((child) => {
                    const 데이터 = child.val();
                    if (!데이터.아이디 || 데이터.아이디.trim() === "") return; // ✅ 랭킹 제외

                    유저리스트.push(데이터);
                });

                // 📊 정렬: 층수 → 몬스터번호 기준 내림차순
                유저리스트.sort((a, b) => {
                    if (b.현재층 !== a.현재층) {
                        return b.현재층 - a.현재층;
                    }
                    return b.현재악마번호 - a.현재악마번호;
                });

                // 🏆 상위 10명만 출력
                유저리스트.slice(0, 10).forEach((유저, index) => {
                    const 줄 = document.createElement("div");
                    줄.className = "양쪽정렬 밑줄";
                    // 줄.className = "양쪽정렬 사백픽셀테두리";
                    if (유저.아이디 === 유저데이터.아이디) {
                        줄.classList.add("내아이디강조");
                    }

                    const 로마번호 = 숫자를로마숫자로(유저.현재악마번호);
                    const 악마이름 = 악마리스트[(유저.현재악마번호 - 1) % 악마리스트.length];

                    document.getElementById("악마이름").innerText = `${로마번호}. ${악마이름}`;



                    // 👑 SVG 아이콘 생성
                    let 왕관색클래스 = "";
                    if (index === 0) 왕관색클래스 = "금";
                    else if (index === 1) 왕관색클래스 = "은";
                    else if (index === 2) 왕관색클래스 = "동";

                    const 왕관 = index < 3
                        ? `<svg xmlns="http://www.w3.org/2000/svg" class="crown-icon ${왕관색클래스}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
           <path d="M2 5l4.5 4.5L12 3l5.5 6.5L22 5l-1 14H3L2 5z" />
           <path d="M5 20h14" />
         </svg>`
                        : ``;

                    줄.innerHTML = `
    <div class="가로정렬">
        ${index < 3 ? 왕관 : `<span>${index + 1}</span>`}
    </div>
    <div>${유저.아이디 || "익명"} - ${유저.현재층}층 ${로마번호}. ${악마이름}</div>
`;
                    컨테이너.appendChild(줄); // ← 이게 없으면 아무 것도 안 그려짐


                });
                // ✅ 여기! 루프 끝나고 나서 딱 1번만 내 줄 추가
                const 내랭킹인덱스 = 유저리스트.findIndex(u => u.아이디 === 유저데이터.아이디);
                const 내랭킹 = 내랭킹인덱스 + 1;

                if (내랭킹 > 10) {
                    const 내줄 = document.createElement("div");
                    내줄.className = "양쪽정렬 사백픽셀테두리 내아이디강조";
                    const 내악마이름 = 악마리스트[(유저데이터.현재악마번호 - 1) % 악마리스트.length];
                    const 내로마번호 = 숫자를로마숫자로(유저데이터.현재악마번호);

                    내줄.innerHTML = `
        <div class="가로정렬">${내랭킹}</div>
        <div>${유저데이터.아이디} - ${유저데이터.현재층}층 ${내로마번호}. ${내악마이름}</div>
    `;
                    컨테이너.appendChild(내줄);
                }
            });
        }



        function 스킬화면보여주기() {
            document.getElementById("전투화면").style.display = "none";
            document.getElementById("에너지박스").style.display = "none";
            document.getElementById("전당화면").style.display = "none";
            document.getElementById("스킬화면").style.display = "block";
            // document.getElementById("사냥로그박스").innerHTML = "";
            document.getElementById("획득로그").innerText = "";
            document.getElementById("레벨업표시").innerText = "";
            document.getElementById("보유숙련도").innerText = "보유 숙련도 " + 유저데이터.숙련도;

            const 클래스맵 = {};
            [...크리티컬스킬목록, ...드레인스킬목록, ...버서커스킬목록].forEach(스킬 => {
                const 매칭 = 스킬.키.replace(/크리티컬확률|드레인흡혈확률|버서커데미지증가확률/, '');
                클래스맵[스킬.키] = 매칭;
            });

            const 컨테이너 = document.getElementById("스킬컨테이너");
            컨테이너.innerHTML = "";

            // 스킬 초기화 (기존 유저용)
            if (!유저데이터.스킬) {
                유저데이터.스킬 = {};
            }
            for (const 스킬 of 스킬목록) {
                if (!(스킬.키 in 유저데이터.스킬)) {
                    유저데이터.스킬[스킬.키] = 0;
                }
            }

            // 렌더링
            스킬목록.forEach(스킬 => {
                const 조건 = 스킬.잠금해제조건;
                const 잠김 = 조건 && (유저데이터.스킬?.[조건.키] ?? 0) < 조건.최소레벨;
                if (잠김) return;

                const 상위스킬찍힘 = 스킬목록.some(다른스킬 => {
                    const 상위조건 = 다른스킬.잠금해제조건;
                    return 상위조건 &&
                        상위조건.키.toLowerCase() === 스킬.키.toLowerCase() &&
                        (유저데이터.스킬?.[다른스킬.키] ?? 0) > 0;
                });
                if (상위스킬찍힘) return;

                const 레벨 = 유저데이터.스킬[스킬.키];
                const 확률 = 레벨 * 10;

                const 클래스명 = 클래스맵[스킬.키] ?? "";

                const 아이콘HTML = 스킬.키.includes("버서커")
                    ? `<svg xmlns="http://www.w3.org/2000/svg" class="flame-icon ${클래스명}" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
             <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6
             .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294
             1-3a2.5 2.5 0 0 0 2.5 2.5z"/>
           </svg>`
                    : 스킬.키.includes("드레인")
                        ? `<svg xmlns="http://www.w3.org/2000/svg" class="drain-icon ${클래스명}" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
             <path d="m18 2 4 4" />
             <path d="m17 7 3-3" />
             <path d="M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-.6-.6c-1-1-1-2.5 0-3.4L15 5" />
             <path d="m9 11 4 4" />
             <path d="m5 19-3 3" />
             <path d="m14 4 6 6" />
           </svg>`
                        : `<svg xmlns="http://www.w3.org/2000/svg" class="target-icon ${클래스명}" viewBox="0 0 24 24" fill="none" stroke="currentColor">
             <circle cx="12" cy="12" r="10" />
             <circle cx="12" cy="12" r="6" />
             <circle cx="12" cy="12" r="2" />
           </svg>`;

                const 박스 = document.createElement("div");
                박스.className = "기본테두리 세로정렬";
                const 소모량 = Math.floor(10 * Math.pow(1.2, 누적스킬투자횟수()));

                박스.innerHTML = `
      <div class="양쪽정렬">
        <div class="가로정렬">${아이콘HTML}${스킬.이름}</div>
        <div>${레벨} / ${스킬.최대레벨}</div>
      </div>
      <div class="양쪽정렬">
        <div style="font-size: 11px; font-weight: lighter;">
${스킬.설명} (${확률}% / 🔧 ${소모량}숙련도)

        </div>
        <div>
          <button onclick="스킬투자('${스킬.키}')">+</button>
          <button onclick="스킬회수('${스킬.키}')">-</button>
      <button onclick="스킬최대투자('${스킬.키}')">M</button>
      <button onclick="스킬전부회수('${스킬.키}')">R</button>
           </div>
      </div>
    `;

                컨테이너.appendChild(박스);
            });
        }

        function 스킬투자(스킬키) {
            const 스킬 = 스킬목록.find(s => s.키 === 스킬키);
            if (!스킬) return alert("존재하지 않는 스킬입니다.");

            const 누적투자수 = 누적스킬투자횟수();
            const 소모량 = Math.floor(10 * Math.pow(1.2, 누적투자수));

            if (유저데이터.숙련도 < 소모량) return alert(`숙련도가 부족합니다. (${소모량} 필요)`);

            유저데이터.숙련도 -= 소모량;
            유저데이터.스킬[스킬키] += 1;

            화면잠금();
            db.ref("users/" + uid).set(유저데이터).then(() => {
                스킬화면보여주기();
                화면해제();
            });
        }

        function 스킬회수(스킬키) {
            const 스킬 = 스킬목록.find(s => s.키 === 스킬키);
            if (!스킬) return alert("존재하지 않는 스킬입니다.");

            const 회수량 = 스킬.숙련도소모 ?? 100;
            const 레벨 = 유저데이터.스킬[스킬키];
            if (레벨 <= 0) return alert("회수할 수 없습니다.");

            유저데이터.숙련도 += 회수량;
            유저데이터.스킬[스킬키] -= 1;

            화면잠금();
            db.ref("users/" + uid).set(유저데이터).then(() => {
                스킬화면보여주기();
                화면해제();
            });
        }

        function 스킬최대투자(스킬키) {
            const 스킬 = 스킬목록.find(s => s.키 === 스킬키);
            if (!스킬) return;

            const 현재레벨 = 유저데이터.스킬[스킬키];
            const 최대레벨 = 스킬.최대레벨;
            const 남은레벨 = 최대레벨 - 현재레벨;
            const 소모량 = 스킬.숙련도소모 ?? 100;

            const 투자가능레벨 = Math.min(
                Math.floor(유저데이터.숙련도 / 소모량),
                남은레벨
            );
            if (투자가능레벨 <= 0) return alert("숙련도가 부족하거나 최대레벨입니다.");

            유저데이터.숙련도 -= 투자가능레벨 * 소모량;
            유저데이터.스킬[스킬키] += 투자가능레벨;

            화면잠금();
            db.ref("users/" + uid).set(유저데이터).then(() => {
                스킬화면보여주기();
                화면해제();
            });
        }

        function 스킬전부회수(스킬키) {
            const 스킬 = 스킬목록.find(s => s.키 === 스킬키);
            if (!스킬) return;

            const 현재레벨 = 유저데이터.스킬[스킬키];
            if (현재레벨 <= 0) return alert("회수할 수 없습니다.");

            const 회수량 = 스킬.숙련도소모 ?? 100;
            유저데이터.숙련도 += 현재레벨 * 회수량;
            유저데이터.스킬[스킬키] = 0;

            화면잠금();
            db.ref("users/" + uid).set(유저데이터).then(() => {
                스킬화면보여주기();
                화면해제();
            });
        }


        function 적용된크리티컬배율() {
            const 그리스이름들 = [
                "알파", "베타", "감마", "델타", "엡실론", "제타", "에타", "쎄타", "이오타", "카파",
                "람다", "뮤", "뉴", "크시", "오미크론", "파이", "로", "시그마", "타우", "입실론",
                "파이2", "카이", "프시", "오메가"
            ];

            let 누적배율 = 1.0;
            let 마지막발동 = null;

            for (let i = 0; i < 그리스이름들.length; i++) {
                const 이름 = 그리스이름들[i];
                const 키 = `${이름.toLowerCase()}크리티컬확률`;
                const 레벨 = 유저데이터.스킬?.[키] ?? 0;
                const 확률 = 레벨 * 10;

                const 발동 = 확률 >= 100 || Math.random() * 100 < 확률;
                if (발동) {
                    누적배율 *= (1.1 + i * 0.1);
                    마지막발동 = { 이름: `${이름} 크리티컬`, 클래스: 이름.toLowerCase() };
                } else {
                    break; // 선행 스킬 미발동 시 이후는 건너뜀
                }
            }

            return {
                배율: 누적배율,
                스킬이름: 마지막발동?.이름 ?? null,
                클래스: 마지막발동?.클래스 ?? null
            };
        }

        function 드레인회복계산() {
            const 드레인이름들 = [
                "킬로", "메가", "기가", "테라", "페타",
                "엑사", "제타", "요타", "로나", "쿼카"
            ];

            let 총회복량 = 0;
            let 마지막발동 = null;

            for (let i = 0; i < 드레인이름들.length; i++) {
                const 이름 = 드레인이름들[i];
                const 키 = `${이름.toLowerCase()}드레인흡혈확률`;
                const 레벨 = 유저데이터.스킬?.[키] ?? 0;
                const 확률 = 레벨 * 10;

                if (레벨 > 0) {
                    const 발동 = 확률 >= 100 || Math.random() * 100 < 확률;
                    if (발동) {
                        총회복량 += (i + 1); // 1부터 시작 (킬로 = 1, 메가 = 2, ...)
                        마지막발동 = 이름;
                    } else {
                        break;
                    }
                } else {
                    break;
                }
            }

            return {
                회복량: 총회복량,
                발동스킬: 마지막발동
            };
        }

        function 버서커데미지배율() {
            const 이름들 = [
                "앵거", "레이지", "프렌지", "매드니스", "하울",
                "새비지", "블러드", "카오스", "데스", "루나틱"
            ];

            // 각 스킬별 배율
            const 배율목록 = [1.3, 1.6, 1.9, 2.2, 2.5, 2.8, 3.1, 3.4, 3.7, 4.0];

            const 체력비율 = 유저데이터.남은체력 / 유저데이터.최대체력;
            if (체력비율 > 0.3) return 1.0;

            let 누적배율 = 1.0;

            for (let i = 0; i < 이름들.length; i++) {
                const 이름 = 이름들[i];
                const 키 = `${이름.toLowerCase()}버서커데미지증가확률`;
                const 레벨 = 유저데이터.스킬?.[키] ?? 0;
                const 확률 = 레벨 * 10;

                const 발동 = 확률 >= 100 || Math.random() * 100 < 확률;
                if (발동) {
                    누적배율 *= 배율목록[i];
                } else {
                    break; // 연속 발동 실패 시 중단
                }
            }

            return 누적배율;
        }

        function 버서커체력소모량() {
            const 이름들 = [
                "앵거", "레이지", "프렌지", "매드니스", "하울",
                "새비지", "블러드", "카오스", "데스", "루나틱"
            ];

            let 소모합계 = 1;

            for (const 이름 of 이름들) {
                const 키 = `${이름.toLowerCase()}버서커데미지증가확률`;
                const 레벨 = 유저데이터.스킬?.[키] ?? 0;
                if (레벨 > 0) 소모합계 += 1;
                else break; // 연속 조건 미충족 시 중단
            }

            return 소모합계;
        }

        function 흡혈로그보여주기(발동스킬, 회복량) {
            const 대상 = document.querySelector(".유저테두리");
            if (!대상) return;

            const rect = 대상.getBoundingClientRect();

            const 아이콘HTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="drain-icon ${발동스킬?.toLowerCase()}" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="m18 2 4 4" />
      <path d="m17 7 3-3" />
      <path d="M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-.6-.6c-1-1-1-2.5 0-3.4L15 5" />
      <path d="m9 11 4 4" />
      <path d="m5 19-3 3" />
      <path d="m14 4 6 6" />
    </svg>
  `;

            const el = document.createElement("div");
            el.innerHTML = `${아이콘HTML} ${발동스킬} 드레인! 체력 +${회복량}`;
            el.style.position = "absolute";
            el.style.left = `${rect.left + Math.random() * rect.width}px`;
            el.style.top = `${rect.top + Math.random() * rect.height}px`;
            el.style.color = "#f43f5e";
            el.style.fontWeight = "bold";
            el.style.fontSize = "13px";
            el.style.display = "inline-flex";
            el.style.alignItems = "center";
            el.style.gap = "5px";
            el.style.padding = "4px 8px";
            el.style.background = "rgba(0, 0, 0, 0.7)";
            el.style.borderRadius = "6px";
            el.style.pointerEvents = "none";
            el.style.whiteSpace = "nowrap";
            el.style.zIndex = "9999";
            el.style.animation = "fadeOut 2s ease-in-out forwards";

            document.body.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        function 고정이펙트영역초기화() {
            const 유저 = document.querySelector(".유저테두리");
            const 몬스터 = document.querySelector(".몬스터테두리");
            const 박스 = document.getElementById("고정이펙트영역");

            if (!유저 || !몬스터 || !박스) return;

            const u = 유저.getBoundingClientRect();
            const m = 몬스터.getBoundingClientRect();

            박스.style.top = `${u.top}px`;
            박스.style.left = `${u.left}px`;
            박스.style.width = `${u.width}px`;
            박스.style.height = `${m.bottom - u.top}px`;
            박스.style.display = "block";
        }


        document.getElementById("보유숙련도").addEventListener("click", () => {
            if (!confirm("모든 스킬 포인트를 회수하시겠습니까?")) return;

            for (const 스킬 of 스킬목록) {
                const 키 = 스킬.키;
                const 레벨 = 유저데이터.스킬[키] ?? 0;
                const 회수량 = 스킬.숙련도소모 ?? 10;
                유저데이터.숙련도 += 회수량 * 레벨;
                유저데이터.스킬[키] = 0;
            }


            화면잠금();
            db.ref("users/" + uid).set(유저데이터).then(() => {
                alert("스킬 포인트가 모두 회수되었습니다.");
                스킬화면보여주기();
                화면해제();
            });
        });



        function 아이디설정() {
            const 입력아이디 = document.getElementById("아이디입력").value.trim();
            if (!입력아이디) return alert("아이디를 입력해주세요.");

            // 1️⃣ 아이디 중복 여부 확인
            화면잠금();
            db.ref("users").orderByChild("아이디").equalTo(입력아이디).once("value", (snapshot) => {
                if (snapshot.exists()) {
                    화면해제();
                    return alert("이미 존재하는 아이디입니다. 다른 이름을 입력해주세요.");
                }

                // 2️⃣ 중복 아니면 저장 진행
                유저데이터.아이디 = 입력아이디;
                db.ref("users/" + uid).set(유저데이터).then(() => {
                    전투화면보여주기(유저데이터);
                    화면해제();
                });
            });
        }

        document.getElementById("타이틀을아이디로").addEventListener("click", () => {
            const el = document.getElementById("타이틀을아이디로");

            // 이미 인풋 상태면 중복 생성 방지
            if (el.querySelector("input")) return;

            const 현재아이디 = 유저데이터.아이디 || "";
            const input = document.createElement("input");
            input.type = "text";
            input.value = 현재아이디;
            input.maxLength = 8;
            input.style.width = "120px";
            input.style.fontSize = "inherit";

            // 기존 텍스트 제거하고 input 삽입
            el.innerHTML = "";
            el.appendChild(input);
            input.focus();

            // 엔터로 저장
            input.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    const 새아이디 = input.value.trim();
                    if (!새아이디) return alert("아이디를 입력해주세요.");

                    화면잠금();

                    db.ref("users").orderByChild("아이디").equalTo(새아이디).once("value", (snapshot) => {
                        const 이미존재 = snapshot.exists() && 새아이디 !== 현재아이디;

                        if (이미존재) {
                            화면해제();
                            alert("이미 존재하는 아이디입니다. 다른 이름을 입력해주세요.");
                            input.focus();
                            return;
                        }

                        // 저장 진행
                        유저데이터.아이디 = 새아이디;
                        db.ref("users/" + uid).set(유저데이터).then(() => {
                            el.innerText = 새아이디;
                            document.getElementById("타이틀을아이디로").innerText = 새아이디;
                            document.getElementById("유저아이디").innerText = 새아이디;
                            화면해제();
                        });
                    });
                }

                // Esc 누르면 취소
                if (e.key === "Escape") {
                    el.innerText = 현재아이디;
                }
            });

            // 포커스 벗어나면 원래대로 (변경 취소)
            input.addEventListener("blur", () => {
                el.innerText = 현재아이디;
            });
        });


        const 악마리스트 = [
            "디나르", "에리곤", "도레알", "크로셀", "루페스", "벨", "시에르", "세레우스", "버알베리스", "발라크",
            "로노베", "자간", "안드라멜리우스", "니베로스", "에이몬", "라에스", "아라타바", "바티바스", "아몬", "안드로말리우스",
            "바피메트", "오로이아스", "오세", "아미", "데카브리아", "벨리알", "디카리브", "세이르", "오로버스", "무루무르",
            "카이미", "알로세스", "샤르나크", "샤크", "사브낙", "라하브", "말포르스", "하우레스", "피닉스", "부알",
            "푸르카스", "가프", "아스모데우스", "포르카스", "보락스", "글라시아라볼라스", "나베리우스", "아이몬", "프루푸스", "살로스",
            "하프리", "페니악스", "다이몬", "스틸", "마르코시아스", "보트스", "제파르", "엘리고스", "레리어", "베레트",
            "시트리", "구시온", "부에르", "카임", "포르네우스", "부네", "아몬", "마라바스", "푸르손", "말파스",
            "파임", "바르바토스", "아가레스", "바알"
        ];

        function 숫자를로마숫자로(num) {
            const 로마 = ["M", "CM", "D", "CD", "C", "XC", "L", "XL", "X", "IX", "V", "IV", "I"];
            const 값 = [1000, 900, 500, 400, 100, 90, 50, 40, 10, 9, 5, 4, 1];
            let 결과 = "";
            for (let i = 0; i < 값.length; i++) {
                while (num >= 값[i]) {
                    결과 += 로마[i];
                    num -= 값[i];
                }
            }
            return 결과;
        }


        function 현재악마불러오기(층, 번호, 등급 = "일반") {
            const 악마수 = 72;

            // 🧩 기본값
            let 체력기본 = 200;
            let 방어기본 = 10;

            // 🔁 층마다 1.5배씩 증가
            for (let i = 1; i < 층; i++) {
                체력기본 *= 1.5;
                방어기본 *= 1.5;
            }

            // 🔀 스탯에 랜덤 80%~120% 적용
            const 체력 = Math.floor(체력기본 * (Math.random() * 0.4 + 0.8));
            const 방어력 = Math.floor(방어기본 * (Math.random() * 0.4 + 0.8));

            // 🧩 등급 보정
            let 최종체력 = 체력;
            let 최종방어 = 방어력;
            switch (등급) {
                case "레어":
                    최종체력 = Math.floor(체력 * 1.5);
                    최종방어 = Math.floor(방어력 * 1.5);
                    break;
                case "신화":
                    최종체력 = Math.floor(체력 * 2.0);
                    최종방어 = Math.floor(방어력 * 2.0);
                    break;
                case "고대":
                    최종체력 = Math.floor(체력 * 3.0);
                    최종방어 = Math.floor(방어력 * 3.0);
                    break;
            }

            return {
                층,
                번호,
                체력: 최종체력,
                방어력: 최종방어,
            };
        }

        function 누적스킬투자횟수() {
            return Object.values(유저데이터.스킬 || {}).reduce((a, b) => a + b, 0);
        }

        document.getElementById("탈퇴").addEventListener("click", function () {
            if (!uid) return alert("로그인이 되어 있지 않습니다.");


            if (confirm("정말 탈퇴하시겠습니까? 모든 데이터가 삭제됩니다.")) {
                // 🔥 해당 uid 전체 데이터 완전 삭제
                화면잠금();
                db.ref("users/" + uid).remove().then(() => {
                    alert("모든 데이터가 초기화되었습니다. 새로고침하면 로그인 화면이 나옵니다.");
                    location.reload(); // 새로고침해서 다시 익명 로그인부터
                    화면해제();
                });
            }


        });


        function 공격하기() {
            if (현재악마체력 <= 0 || 유저데이터.남은체력 <= 0) return;

            화면잠금();

            // ✅ 몬스터 이름 일관성 있게 추출
            const 악마 = 현재악마불러오기(유저데이터.현재층, 유저데이터.현재악마번호);
            const 악마이름 = 악마리스트[(유저데이터.현재악마번호 - 1) % 악마리스트.length];
            const 로마번호 = 숫자를로마숫자로(유저데이터.현재악마번호);
            const 몬스터이름 = `${로마번호}. ${악마이름}`;
            const 전투중몬스터이름 = 현재몬스터이름;
            const 전투중몬스터등급 = 현재몬스터등급;

            let 악마HP = 악마.체력;
            let 유저HP = 유저데이터.남은체력;
            let 전투결과 = null;

            while (악마HP > 0 && 유저HP > 0) {
                const 유저공 = 유저데이터.공격력;
                const 방어 = 악마.방어력;
                const 랜덤 = Math.random() * 0.2 + 0.8;
                const { 배율: 크리배율 } = 적용된크리티컬배율();
                const 버서커배율 = 버서커데미지배율();
                const 체력소모 = 버서커체력소모량();

                const 데미지 = Math.floor(Math.max(0, 유저공 - 방어) * 랜덤 * 크리배율 * 버서커배율);

                악마HP -= 데미지;
                유저HP = Math.max(0, 유저HP - 체력소모);
            }

            전투결과 = (유저HP <= 0) ? "패배" : "승리";

            setTimeout(() => {
                if (전투결과 === "패배") {
                    // ✅ 후퇴 처리
                    유저데이터.남은체력 = 유저데이터.최대체력;

                    유저데이터.현재악마번호 = Math.floor(Math.random() * 72) + 1;
                    // 유저데이터.현재층은 그대로

                    db.ref("users/" + uid).set(유저데이터).then(() => {
                        전투화면보여주기();
                        document.getElementById("승리패배로그").innerText = "패배";
                        document.getElementById("승리패배로그").style.color = "red";
                        document.getElementById("획득로그").style.color = "red";
                        document.getElementById("레벨업표시").innerText = "";
                        document.getElementById("획득로그").innerText = "이 전 몬스터로 돌아갑니다";
                        죽음메시지보여주기("💀 체력이 모두 소진되어 후퇴합니다!");
                        화면해제();
                    });

                } else {
                    const { 회복량, 발동스킬 } = 드레인회복계산();
                    유저HP = Math.min(유저데이터.최대체력, 유저HP + 회복량);

                    const 보상 = 보상획득(유저데이터.현재층);
                    const 이전레벨 = 유저데이터.레벨;

                    유저데이터.남은체력 = 유저HP;
                    유저데이터.경험치 += 보상.경험치;
                    유저데이터.골드 += 보상.골드;
                    유저데이터.숙련도 += 보상.숙련도;

                    const 새레벨 = Math.floor(유저데이터.경험치 / 100) + 1;
                    if (새레벨 > 이전레벨) {
                        const 증가량 = 새레벨 - 이전레벨;
                        유저데이터.레벨 = 새레벨;
                        유저데이터.공격력 += 증가량 * 15;
                        유저데이터.남은체력 = 유저데이터.최대체력;
                    }

                    유저데이터.현재악마번호 = Math.floor(Math.random() * 72) + 1;

                    db.ref("users/" + uid).set(유저데이터).then(() => {
                        전투화면보여주기();

                        // ✅ 승리 UI 출력
                        document.getElementById("승리패배로그").innerText = "승리";
                        document.getElementById("승리패배로그").style.color = "#00c851";
                        document.getElementById("획득로그").style.color = "#00c851";
                        document.getElementById("획득로그").innerText =
                            `${보상.경험치} EXP, ${보상.골드} Gold, ${보상.숙련도} 숙련도 획득`;
                        document.getElementById("획득경험치").innerText = `+${보상.경험치}`;
                        document.getElementById("획득골드").innerText = `+${보상.골드}`;
                        document.getElementById("획득숙련도").innerText = `+${보상.숙련도}`;
                        document.getElementById("레벨업표시").innerText =
                            (새레벨 > 이전레벨) ? "레벨업!" : "";

                        if (회복량 > 0) {
                            흡혈로그보여주기(발동스킬, 회복량);
                        }

                        죽음메시지보여주기(`${전투중몬스터이름} 처치!`);
                        화면해제();
                    });
                }
            }, 100);
        }

        document.getElementById("아래층으로").addEventListener("click", () => {
            if (유저데이터.현재층 > 1) {
                유저데이터.현재층 -= 1;
                유저데이터.현재악마번호 = Math.floor(Math.random() * 72) + 1;
                전투화면보여주기(유저데이터);
            }
        });

        document.getElementById("위층으로").addEventListener("click", () => {
            유저데이터.현재층 += 1;
            유저데이터.현재악마번호 = Math.floor(Math.random() * 72) + 1;
            전투화면보여주기(유저데이터);
        });


        function 데미지표시(텍스트) {
            const el = document.createElement("div");
            el.innerText = 텍스트;

            el.style.position = "absolute";
            el.style.left = `${Math.random() * 80 + 10}%`;  // 10% ~ 90%
            el.style.top = `${Math.random() * 70 + 15}%`;   // 15% ~ 85%
            el.style.color = "orange";
            el.style.fontWeight = "bold";
            el.style.fontSize = "16px";
            el.style.pointerEvents = "none";
            el.style.whiteSpace = "nowrap";
            el.style.zIndex = "9999";
            el.style.animation = "fadeOut 1.5s ease-out forwards";

            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1500);
        }

        function 보상획득(층) {
            const 경험치 = Math.floor(Math.random() * 15) + 10;
            // const 경험치 = Math.floor(Math.random() * 10) + 층 * 10; // 1층: 10~19
            const 골드 = Math.floor(Math.random() * 100) + 층 * 100;      // 100~199
            const 숙련도 = 층;                                       // 층수 = 숙련도


            return { 경험치, 골드, 숙련도 };
        }


        window.addEventListener("DOMContentLoaded", function () {
            document.getElementById("공격버튼").addEventListener("click", 공격하기);
        });


        function 죽음메시지보여주기(text) {
            const 대상 = document.querySelector(".몬스터테두리");
            if (!대상) return;

            const rect = 대상.getBoundingClientRect();

            const el = document.createElement("div");
            el.innerText = text;
            el.style.position = "absolute";
            el.style.left = `${rect.left + Math.random() * rect.width}px`;
            el.style.top = `${rect.top + Math.random() * rect.height}px`;
            el.style.color = "#b0b0b0";
            el.style.background = "rgba(0, 0, 0, 0.8)";
            el.style.padding = "10px 20px";
            el.style.border = "2px solid #2e2e2e";
            el.style.borderRadius = "12px";
            el.style.fontWeight = "bold";
            el.style.fontSize = "14px";
            el.style.pointerEvents = "none";
            el.style.zIndex = "9999";
            el.style.whiteSpace = "nowrap";
            el.style.animation = "fadeOut 2s ease-in-out forwards";
            el.style.boxShadow = "0 0 20px rgba(234, 0, 255, 0.6)";

            document.body.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        function 자동사냥토글() {
            const 버튼 = document.getElementById("자동사냥버튼");

            if (!자동사냥중) {
                자동사냥중 = true;
                버튼.innerText = "🛑 자동중지";
                버튼.style.color = "red";

                자동사냥타이머 = setInterval(() => {
                    if (!자동사냥중 || 유저데이터.남은체력 <= 0) return;
                    공격하기();
                }, 1000); // 1초 시뮬 + 약간 여유
            } else {
                자동사냥중 = false;
                clearInterval(자동사냥타이머);
                자동사냥타이머 = null;

                버튼.innerText = "⏱ 자동사냥";
                버튼.style.color = "white";
            }
        }

        document.getElementById("자동사냥버튼").addEventListener("click", 자동사냥토글);

        document.getElementById("전당").addEventListener("click", () => {
            전당화면보여주기();
        });

        document.getElementById("스킬").addEventListener("click", () => {
            스킬화면보여주기();
        });

        document.getElementById("전투").addEventListener("click", () => {
            전투화면보여주기(유저데이터);
        });

        document.addEventListener("click", (e) => {
            // 자동사냥 중일 때만 멈춤
            if (자동사냥중 && !e.target.closest("#자동사냥버튼")) {
                자동사냥중 = false;
                clearInterval(자동사냥타이머);
                자동사냥타이머 = null;

                const 버튼 = document.getElementById("자동사냥버튼");
                버튼.innerText = "⏱ 자동사냥";
                버튼.style.color = "white";
            }
        });










        // 스크립트추가





    </script>







</body>

</html>